/* 
 *  IMS Open Corpus Workbench (CWB)
 *  Copyright (C) 1993-2006 by IMS, University of Stuttgart
 *  Copyright (C) 2007-     by the respective contributers (see file AUTHORS)
 * 
 *  This program is free software; you can redistribute it and/or modify it
 *  under the terms of the GNU General Public License as published by the
 *  Free Software Foundation; either version 2, or (at your option) any later
 *  version.
 * 
 *  This program is distributed in the hope that it will be useful, but
 *  WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General
 *  Public License for more details (in the file "COPYING", or available via
 *  WWW at http://www.gnu.org/copyleft/gpl.html).
 */

#include <ctype.h>

#include <glib.h>

#include "globals.h"

#include "special-chars.h"



/* ---------------------------------------------------- */
/* composite tables that can automatically be generated */
/* ---------------------------------------------------- */

/**
 * Array of mapping tables used when NEITHER case NOR diacritics are to be stripped.
 *
 * These are composite tables: they are only generated when needed (the corresponding
 * identity_tab_init value is a boolean indicating whether this has been done yet).
 *
 * Use a CorpusCharset value as the index into this array.
 */
const unsigned char identity_tab[unknown_charset][256];
int identity_tab_init[unknown_charset] = {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0};

/**
 * Array of mapping tables used when BOTH case AND diacritics are to be stripped.
 *
 * These are composite tables: they are only generated when needed (the corresponding
 * identity_tab_init value is a boolean indicating whether this has been done yet).
 *
 * Use a CorpusCharset value as the index into this array.
 */
unsigned char nocase_nodiac_tab[unknown_charset][256];
int nocase_nodiac_tab_init[unknown_charset] = {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0};


/* ------------------------------------------------------------------------------ */
/* tables that are created at compile time, contain mapping data for all charsets */
/* ------------------------------------------------------------------------------ */

/**
 * Array of tables mapping a character (the index) to the
 * equivalent character without any accents (the value).
 *
 * There are as many tables as there are possible values of
 * CorpusCharset. Moreover, tables must always be in the
 * same order as the values of CorpusCharset are declared in.
 *
 * This means stareting at ascii == 0 and working up through the canonical
 * order that is observable in cl.h
 *
 * Use a CorpusCharset value as the index into this array.
 *
 * @see CorpusCharset
 */
unsigned char nodiac_tab[unknown_charset][256] = {

    /* ASCII: identity as there are no accented chars less than 0x80;
     * any bytes in the upper half are malfoprmed, so just pass them through;
     * table only needed to make ythe array work correctly */
    {
        0,
        1,  2,  3,  4,  5,  6,  7,  8,  9, 10,
       11, 12, 13, 14, 15, 16, 17, 18, 19, 20,
       21, 22, 23, 24, 25, 26, 27, 28, 29, 30,
       31, 32, 33, 34, 35, 36, 37, 38, 39, 40,
       41, 42, 43, 44, 45, 46, 47, 48, 49, 50,
       51, 52, 53, 54, 55, 56, 57, 58, 59, 60,
       61, 62, 63, 64, 65, 66, 67, 68, 69, 70,
       71, 72, 73, 74, 75, 76, 77, 78, 79, 80,
       81, 82, 83, 84, 85, 86, 87, 88, 89, 90,
       91, 92, 93, 94, 95, 96, 97, 98, 99,100,
      101,102,103,104,105,106,107,108,109,110,
      111,112,113,114,115,116,117,118,119,120,
      121,122,123,124,125,126,127,128,129,130,
      131,132,133,134,135,136,137,138,139,140,
      141,142,143,144,145,146,147,148,149,150,
      151,152,153,154,155,156,157,158,159,160,
      161,162,163,164,165,166,167,168,169,170,
      171,172,173,174,175,176,177,178,179,180,
      181,182,183,184,185,186,187,188,189,190,
      191,192,193,194,195,196,197,198,199,200,
      201,202,203,204,205,206,207,208,209,210,
      211,212,213,214,215,216,217,218,219,220,
      221,222,223,224,225,226,227,228,229,230,
      231,232,233,234,235,236,237,238,239,240,
      241,242,243,244,245,246,247,248,249,250,
      251,252,253,254,255
    },
    /* latin 1 */
    {
        0,
        1,  2,  3,  4,  5,  6,  7,  8,  9, 10,
       11, 12, 13, 14, 15, 16, 17, 18, 19, 20,
       21, 22, 23, 24, 25, 26, 27, 28, 29, 30,
       31, 32, 33, 34, 35, 36, 37, 38, 39, 40,
       41, 42, 43, 44, 45, 46, 47, 48, 49, 50,
       51, 52, 53, 54, 55, 56, 57, 58, 59, 60,
       61, 62, 63, 64, 65, 66, 67, 68, 69, 70,
       71, 72, 73, 74, 75, 76, 77, 78, 79, 80,
       81, 82, 83, 84, 85, 86, 87, 88, 89, 90,
       91, 92, 93, 94, 95, 96, 97, 98, 99,100,
      101,102,103,104,105,106,107,108,109,110,
      111,112,113,114,115,116,117,118,119,120,
      121,122,123,124,125,126,127,128,129,130,
      131,132,133,134,135,136,137,138,139,140,
      141,142,143,144,145,146,147,148,149,150,
      151,152,153,154,155,156,157,158,159,160,
      161,162,163,164,165,166,167,168,169,170,
      171,172,173,174,175,176,177,178,179,180,
      181,182,183,184,185,186,187,188,189,190,
      191,
           65, 65, 65, 65, 65, 65, 65, 67, 69, /* uppercase */
       69, 69, 69, 73, 73, 73, 73, 68, 78, 79,
       79, 79, 79, 79,215, 79, 85, 85, 85, 85,
       89, 84,115,                  /* thorn -> 'T', szlig -> 's' */
                   97, 97, 97, 97, 97, 97, 97, /* lowercase */
       99,101,101,101,101,105,105,105,105,100,
      110,111,111,111,111,111,247,111,117,117,
      117,117,121,116,121
    },
    /* latin2 : TODO change this from identity if necessary */
    {
        0,
        1,  2,  3,  4,  5,  6,  7,  8,  9, 10,
       11, 12, 13, 14, 15, 16, 17, 18, 19, 20,
       21, 22, 23, 24, 25, 26, 27, 28, 29, 30,
       31, 32, 33, 34, 35, 36, 37, 38, 39, 40,
       41, 42, 43, 44, 45, 46, 47, 48, 49, 50,
       51, 52, 53, 54, 55, 56, 57, 58, 59, 60,
       61, 62, 63, 64, 65, 66, 67, 68, 69, 70,
       71, 72, 73, 74, 75, 76, 77, 78, 79, 80,
       81, 82, 83, 84, 85, 86, 87, 88, 89, 90,
       91, 92, 93, 94, 95, 96, 97, 98, 99,100,
      101,102,103,104,105,106,107,108,109,110,
      111,112,113,114,115,116,117,118,119,120,
      121,122,123,124,125,126,127,128,129,130,
      131,132,133,134,135,136,137,138,139,140,
      141,142,143,144,145,146,147,148,149,150,
      151,152,153,154,155,156,157,158,159,160,
      161,162,163,164,165,166,167,168,169,170,
      171,172,173,174,175,176,177,178,179,180,
      181,182,183,184,185,186,187,188,189,190,
      191,192,193,194,195,196,197,198,199,200,
      201,202,203,204,205,206,207,208,209,210,
      211,212,213,214,215,216,217,218,219,220,
      221,222,223,224,225,226,227,228,229,230,
      231,232,233,234,235,236,237,238,239,240,
      241,242,243,244,245,246,247,248,249,250,
      251,252,253,254,255
    },
    /* latin3 : TODO change this from identity if necessary */
    {
        0,
        1,  2,  3,  4,  5,  6,  7,  8,  9, 10,
       11, 12, 13, 14, 15, 16, 17, 18, 19, 20,
       21, 22, 23, 24, 25, 26, 27, 28, 29, 30,
       31, 32, 33, 34, 35, 36, 37, 38, 39, 40,
       41, 42, 43, 44, 45, 46, 47, 48, 49, 50,
       51, 52, 53, 54, 55, 56, 57, 58, 59, 60,
       61, 62, 63, 64, 65, 66, 67, 68, 69, 70,
       71, 72, 73, 74, 75, 76, 77, 78, 79, 80,
       81, 82, 83, 84, 85, 86, 87, 88, 89, 90,
       91, 92, 93, 94, 95, 96, 97, 98, 99,100,
      101,102,103,104,105,106,107,108,109,110,
      111,112,113,114,115,116,117,118,119,120,
      121,122,123,124,125,126,127,128,129,130,
      131,132,133,134,135,136,137,138,139,140,
      141,142,143,144,145,146,147,148,149,150,
      151,152,153,154,155,156,157,158,159,160,
      161,162,163,164,165,166,167,168,169,170,
      171,172,173,174,175,176,177,178,179,180,
      181,182,183,184,185,186,187,188,189,190,
      191,192,193,194,195,196,197,198,199,200,
      201,202,203,204,205,206,207,208,209,210,
      211,212,213,214,215,216,217,218,219,220,
      221,222,223,224,225,226,227,228,229,230,
      231,232,233,234,235,236,237,238,239,240,
      241,242,243,244,245,246,247,248,249,250,
      251,252,253,254,255
    },
    /* latin4 : TODO change this from identity if necessary */
    {
        0,
        1,  2,  3,  4,  5,  6,  7,  8,  9, 10,
       11, 12, 13, 14, 15, 16, 17, 18, 19, 20,
       21, 22, 23, 24, 25, 26, 27, 28, 29, 30,
       31, 32, 33, 34, 35, 36, 37, 38, 39, 40,
       41, 42, 43, 44, 45, 46, 47, 48, 49, 50,
       51, 52, 53, 54, 55, 56, 57, 58, 59, 60,
       61, 62, 63, 64, 65, 66, 67, 68, 69, 70,
       71, 72, 73, 74, 75, 76, 77, 78, 79, 80,
       81, 82, 83, 84, 85, 86, 87, 88, 89, 90,
       91, 92, 93, 94, 95, 96, 97, 98, 99,100,
      101,102,103,104,105,106,107,108,109,110,
      111,112,113,114,115,116,117,118,119,120,
      121,122,123,124,125,126,127,128,129,130,
      131,132,133,134,135,136,137,138,139,140,
      141,142,143,144,145,146,147,148,149,150,
      151,152,153,154,155,156,157,158,159,160,
      161,162,163,164,165,166,167,168,169,170,
      171,172,173,174,175,176,177,178,179,180,
      181,182,183,184,185,186,187,188,189,190,
      191,192,193,194,195,196,197,198,199,200,
      201,202,203,204,205,206,207,208,209,210,
      211,212,213,214,215,216,217,218,219,220,
      221,222,223,224,225,226,227,228,229,230,
      231,232,233,234,235,236,237,238,239,240,
      241,242,243,244,245,246,247,248,249,250,
      251,252,253,254,255
    },
    /* cyrillic : TODO change this from identity if necessary */
    {
        0,
        1,  2,  3,  4,  5,  6,  7,  8,  9, 10,
       11, 12, 13, 14, 15, 16, 17, 18, 19, 20,
       21, 22, 23, 24, 25, 26, 27, 28, 29, 30,
       31, 32, 33, 34, 35, 36, 37, 38, 39, 40,
       41, 42, 43, 44, 45, 46, 47, 48, 49, 50,
       51, 52, 53, 54, 55, 56, 57, 58, 59, 60,
       61, 62, 63, 64, 65, 66, 67, 68, 69, 70,
       71, 72, 73, 74, 75, 76, 77, 78, 79, 80,
       81, 82, 83, 84, 85, 86, 87, 88, 89, 90,
       91, 92, 93, 94, 95, 96, 97, 98, 99,100,
      101,102,103,104,105,106,107,108,109,110,
      111,112,113,114,115,116,117,118,119,120,
      121,122,123,124,125,126,127,128,129,130,
      131,132,133,134,135,136,137,138,139,140,
      141,142,143,144,145,146,147,148,149,150,
      151,152,153,154,155,156,157,158,159,160,
      161,162,163,164,165,166,167,168,169,170,
      171,172,173,174,175,176,177,178,179,180,
      181,182,183,184,185,186,187,188,189,190,
      191,192,193,194,195,196,197,198,199,200,
      201,202,203,204,205,206,207,208,209,210,
      211,212,213,214,215,216,217,218,219,220,
      221,222,223,224,225,226,227,228,229,230,
      231,232,233,234,235,236,237,238,239,240,
      241,242,243,244,245,246,247,248,249,250,
      251,252,253,254,255
    },
    /* arabic : TODO change this from identity if necessary */
    {
        0,
        1,  2,  3,  4,  5,  6,  7,  8,  9, 10,
       11, 12, 13, 14, 15, 16, 17, 18, 19, 20,
       21, 22, 23, 24, 25, 26, 27, 28, 29, 30,
       31, 32, 33, 34, 35, 36, 37, 38, 39, 40,
       41, 42, 43, 44, 45, 46, 47, 48, 49, 50,
       51, 52, 53, 54, 55, 56, 57, 58, 59, 60,
       61, 62, 63, 64, 65, 66, 67, 68, 69, 70,
       71, 72, 73, 74, 75, 76, 77, 78, 79, 80,
       81, 82, 83, 84, 85, 86, 87, 88, 89, 90,
       91, 92, 93, 94, 95, 96, 97, 98, 99,100,
      101,102,103,104,105,106,107,108,109,110,
      111,112,113,114,115,116,117,118,119,120,
      121,122,123,124,125,126,127,128,129,130,
      131,132,133,134,135,136,137,138,139,140,
      141,142,143,144,145,146,147,148,149,150,
      151,152,153,154,155,156,157,158,159,160,
      161,162,163,164,165,166,167,168,169,170,
      171,172,173,174,175,176,177,178,179,180,
      181,182,183,184,185,186,187,188,189,190,
      191,192,193,194,195,196,197,198,199,200,
      201,202,203,204,205,206,207,208,209,210,
      211,212,213,214,215,216,217,218,219,220,
      221,222,223,224,225,226,227,228,229,230,
      231,232,233,234,235,236,237,238,239,240,
      241,242,243,244,245,246,247,248,249,250,
      251,252,253,254,255
    },
    /* greek : TODO change this from identity if necessary */
    {
        0,
        1,  2,  3,  4,  5,  6,  7,  8,  9, 10,
       11, 12, 13, 14, 15, 16, 17, 18, 19, 20,
       21, 22, 23, 24, 25, 26, 27, 28, 29, 30,
       31, 32, 33, 34, 35, 36, 37, 38, 39, 40,
       41, 42, 43, 44, 45, 46, 47, 48, 49, 50,
       51, 52, 53, 54, 55, 56, 57, 58, 59, 60,
       61, 62, 63, 64, 65, 66, 67, 68, 69, 70,
       71, 72, 73, 74, 75, 76, 77, 78, 79, 80,
       81, 82, 83, 84, 85, 86, 87, 88, 89, 90,
       91, 92, 93, 94, 95, 96, 97, 98, 99,100,
      101,102,103,104,105,106,107,108,109,110,
      111,112,113,114,115,116,117,118,119,120,
      121,122,123,124,125,126,127,128,129,130,
      131,132,133,134,135,136,137,138,139,140,
      141,142,143,144,145,146,147,148,149,150,
      151,152,153,154,155,156,157,158,159,160,
      161,162,163,164,165,166,167,168,169,170,
      171,172,173,174,175,176,177,178,179,180,
      181,182,183,184,185,186,187,188,189,190,
      191,192,193,194,195,196,197,198,199,200,
      201,202,203,204,205,206,207,208,209,210,
      211,212,213,214,215,216,217,218,219,220,
      221,222,223,224,225,226,227,228,229,230,
      231,232,233,234,235,236,237,238,239,240,
      241,242,243,244,245,246,247,248,249,250,
      251,252,253,254,255
    },
    /* hebrew : TODO change this from identity if necessary */
    {
        0,
        1,  2,  3,  4,  5,  6,  7,  8,  9, 10,
       11, 12, 13, 14, 15, 16, 17, 18, 19, 20,
       21, 22, 23, 24, 25, 26, 27, 28, 29, 30,
       31, 32, 33, 34, 35, 36, 37, 38, 39, 40,
       41, 42, 43, 44, 45, 46, 47, 48, 49, 50,
       51, 52, 53, 54, 55, 56, 57, 58, 59, 60,
       61, 62, 63, 64, 65, 66, 67, 68, 69, 70,
       71, 72, 73, 74, 75, 76, 77, 78, 79, 80,
       81, 82, 83, 84, 85, 86, 87, 88, 89, 90,
       91, 92, 93, 94, 95, 96, 97, 98, 99,100,
      101,102,103,104,105,106,107,108,109,110,
      111,112,113,114,115,116,117,118,119,120,
      121,122,123,124,125,126,127,128,129,130,
      131,132,133,134,135,136,137,138,139,140,
      141,142,143,144,145,146,147,148,149,150,
      151,152,153,154,155,156,157,158,159,160,
      161,162,163,164,165,166,167,168,169,170,
      171,172,173,174,175,176,177,178,179,180,
      181,182,183,184,185,186,187,188,189,190,
      191,192,193,194,195,196,197,198,199,200,
      201,202,203,204,205,206,207,208,209,210,
      211,212,213,214,215,216,217,218,219,220,
      221,222,223,224,225,226,227,228,229,230,
      231,232,233,234,235,236,237,238,239,240,
      241,242,243,244,245,246,247,248,249,250,
      251,252,253,254,255
    },
    /* latin5 : TODO change this from identity if necessary */
    {
        0,
        1,  2,  3,  4,  5,  6,  7,  8,  9, 10,
       11, 12, 13, 14, 15, 16, 17, 18, 19, 20,
       21, 22, 23, 24, 25, 26, 27, 28, 29, 30,
       31, 32, 33, 34, 35, 36, 37, 38, 39, 40,
       41, 42, 43, 44, 45, 46, 47, 48, 49, 50,
       51, 52, 53, 54, 55, 56, 57, 58, 59, 60,
       61, 62, 63, 64, 65, 66, 67, 68, 69, 70,
       71, 72, 73, 74, 75, 76, 77, 78, 79, 80,
       81, 82, 83, 84, 85, 86, 87, 88, 89, 90,
       91, 92, 93, 94, 95, 96, 97, 98, 99,100,
      101,102,103,104,105,106,107,108,109,110,
      111,112,113,114,115,116,117,118,119,120,
      121,122,123,124,125,126,127,128,129,130,
      131,132,133,134,135,136,137,138,139,140,
      141,142,143,144,145,146,147,148,149,150,
      151,152,153,154,155,156,157,158,159,160,
      161,162,163,164,165,166,167,168,169,170,
      171,172,173,174,175,176,177,178,179,180,
      181,182,183,184,185,186,187,188,189,190,
      191,192,193,194,195,196,197,198,199,200,
      201,202,203,204,205,206,207,208,209,210,
      211,212,213,214,215,216,217,218,219,220,
      221,222,223,224,225,226,227,228,229,230,
      231,232,233,234,235,236,237,238,239,240,
      241,242,243,244,245,246,247,248,249,250,
      251,252,253,254,255
    },
    /* latin6 : TODO change this from identity if necessary */
    {
        0,
        1,  2,  3,  4,  5,  6,  7,  8,  9, 10,
       11, 12, 13, 14, 15, 16, 17, 18, 19, 20,
       21, 22, 23, 24, 25, 26, 27, 28, 29, 30,
       31, 32, 33, 34, 35, 36, 37, 38, 39, 40,
       41, 42, 43, 44, 45, 46, 47, 48, 49, 50,
       51, 52, 53, 54, 55, 56, 57, 58, 59, 60,
       61, 62, 63, 64, 65, 66, 67, 68, 69, 70,
       71, 72, 73, 74, 75, 76, 77, 78, 79, 80,
       81, 82, 83, 84, 85, 86, 87, 88, 89, 90,
       91, 92, 93, 94, 95, 96, 97, 98, 99,100,
      101,102,103,104,105,106,107,108,109,110,
      111,112,113,114,115,116,117,118,119,120,
      121,122,123,124,125,126,127,128,129,130,
      131,132,133,134,135,136,137,138,139,140,
      141,142,143,144,145,146,147,148,149,150,
      151,152,153,154,155,156,157,158,159,160,
      161,162,163,164,165,166,167,168,169,170,
      171,172,173,174,175,176,177,178,179,180,
      181,182,183,184,185,186,187,188,189,190,
      191,192,193,194,195,196,197,198,199,200,
      201,202,203,204,205,206,207,208,209,210,
      211,212,213,214,215,216,217,218,219,220,
      221,222,223,224,225,226,227,228,229,230,
      231,232,233,234,235,236,237,238,239,240,
      241,242,243,244,245,246,247,248,249,250,
      251,252,253,254,255
    },
    /* latin7 : TODO change this from identity if necessary */
    {
        0,
        1,  2,  3,  4,  5,  6,  7,  8,  9, 10,
       11, 12, 13, 14, 15, 16, 17, 18, 19, 20,
       21, 22, 23, 24, 25, 26, 27, 28, 29, 30,
       31, 32, 33, 34, 35, 36, 37, 38, 39, 40,
       41, 42, 43, 44, 45, 46, 47, 48, 49, 50,
       51, 52, 53, 54, 55, 56, 57, 58, 59, 60,
       61, 62, 63, 64, 65, 66, 67, 68, 69, 70,
       71, 72, 73, 74, 75, 76, 77, 78, 79, 80,
       81, 82, 83, 84, 85, 86, 87, 88, 89, 90,
       91, 92, 93, 94, 95, 96, 97, 98, 99,100,
      101,102,103,104,105,106,107,108,109,110,
      111,112,113,114,115,116,117,118,119,120,
      121,122,123,124,125,126,127,128,129,130,
      131,132,133,134,135,136,137,138,139,140,
      141,142,143,144,145,146,147,148,149,150,
      151,152,153,154,155,156,157,158,159,160,
      161,162,163,164,165,166,167,168,169,170,
      171,172,173,174,175,176,177,178,179,180,
      181,182,183,184,185,186,187,188,189,190,
      191,192,193,194,195,196,197,198,199,200,
      201,202,203,204,205,206,207,208,209,210,
      211,212,213,214,215,216,217,218,219,220,
      221,222,223,224,225,226,227,228,229,230,
      231,232,233,234,235,236,237,238,239,240,
      241,242,243,244,245,246,247,248,249,250,
      251,252,253,254,255
    },
    /* latin8 : TODO change this from identity if necessary */
    {
        0,
        1,  2,  3,  4,  5,  6,  7,  8,  9, 10,
       11, 12, 13, 14, 15, 16, 17, 18, 19, 20,
       21, 22, 23, 24, 25, 26, 27, 28, 29, 30,
       31, 32, 33, 34, 35, 36, 37, 38, 39, 40,
       41, 42, 43, 44, 45, 46, 47, 48, 49, 50,
       51, 52, 53, 54, 55, 56, 57, 58, 59, 60,
       61, 62, 63, 64, 65, 66, 67, 68, 69, 70,
       71, 72, 73, 74, 75, 76, 77, 78, 79, 80,
       81, 82, 83, 84, 85, 86, 87, 88, 89, 90,
       91, 92, 93, 94, 95, 96, 97, 98, 99,100,
      101,102,103,104,105,106,107,108,109,110,
      111,112,113,114,115,116,117,118,119,120,
      121,122,123,124,125,126,127,128,129,130,
      131,132,133,134,135,136,137,138,139,140,
      141,142,143,144,145,146,147,148,149,150,
      151,152,153,154,155,156,157,158,159,160,
      161,162,163,164,165,166,167,168,169,170,
      171,172,173,174,175,176,177,178,179,180,
      181,182,183,184,185,186,187,188,189,190,
      191,192,193,194,195,196,197,198,199,200,
      201,202,203,204,205,206,207,208,209,210,
      211,212,213,214,215,216,217,218,219,220,
      221,222,223,224,225,226,227,228,229,230,
      231,232,233,234,235,236,237,238,239,240,
      241,242,243,244,245,246,247,248,249,250,
      251,252,253,254,255
    },
    /* latin9 : TODO change this from identity if necessary */
    {
        0,
        1,  2,  3,  4,  5,  6,  7,  8,  9, 10,
       11, 12, 13, 14, 15, 16, 17, 18, 19, 20,
       21, 22, 23, 24, 25, 26, 27, 28, 29, 30,
       31, 32, 33, 34, 35, 36, 37, 38, 39, 40,
       41, 42, 43, 44, 45, 46, 47, 48, 49, 50,
       51, 52, 53, 54, 55, 56, 57, 58, 59, 60,
       61, 62, 63, 64, 65, 66, 67, 68, 69, 70,
       71, 72, 73, 74, 75, 76, 77, 78, 79, 80,
       81, 82, 83, 84, 85, 86, 87, 88, 89, 90,
       91, 92, 93, 94, 95, 96, 97, 98, 99,100,
      101,102,103,104,105,106,107,108,109,110,
      111,112,113,114,115,116,117,118,119,120,
      121,122,123,124,125,126,127,128,129,130,
      131,132,133,134,135,136,137,138,139,140,
      141,142,143,144,145,146,147,148,149,150,
      151,152,153,154,155,156,157,158,159,160,
      161,162,163,164,165,166,167,168,169,170,
      171,172,173,174,175,176,177,178,179,180,
      181,182,183,184,185,186,187,188,189,190,
      191,192,193,194,195,196,197,198,199,200,
      201,202,203,204,205,206,207,208,209,210,
      211,212,213,214,215,216,217,218,219,220,
      221,222,223,224,225,226,227,228,229,230,
      231,232,233,234,235,236,237,238,239,240,
      241,242,243,244,245,246,247,248,249,250,
      251,252,253,254,255
    },
    /* UTF8: a dummy table which should never be used. The big wall
     * of zeroes should function as a reminder of this! */
    {
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    }
}; /* end initialise: nodiac tables */

/**
 * Array of tables mapping a character (the index) to the
 * equivalent character in lowercase (the value).
 *
 * There are as many tables as there are possible values of
 * CorpusCharset. Moreover, tables must always be in the
 * same order as the values of CorpusCharset are declared in.
 *
 * This means starting at ascii == 0 and working up through the canonical
 * order that is observable in cl.h
 *
 * Use a CorpusCharset value as the index into this array.
 *
 * @see CorpusCharset
 */
unsigned char nocase_tab[unknown_charset][256] = {

    /* ASCII: identity in the top half (to let "bad" characters pass through;
     * same as latin1 in the bottom half. This makes it safe as a fallback for UTF8. */
    {
        0,
        1,  2,  3,  4,  5,  6,  7,  8,  9, 10,
       11, 12, 13, 14, 15, 16, 17, 18, 19, 20,
       21, 22, 23, 24, 25, 26, 27, 28, 29, 30,
       31, 32, 33, 34, 35, 36, 37, 38, 39, 40,
       41, 42, 43, 44, 45, 46, 47, 48, 49, 50,
       51, 52, 53, 54, 55, 56, 57, 58, 59, 60,
       61, 62, 63, 64,
                       97, 98, 99,100,101,102, /* ABCDEF -> abcdef */
      103,104,105,106,107,108,109,110,111,112, /* GHIJKLMNOP -> ghijklmnop */
      113,114,115,116,117,118,119,120,121,122, /* QRSTUVWXYZ -> qrstuvwxyz */

       91, 92, 93, 94, 95, 96, 97, 98, 99,100, /* normal */
      101,102,103,104,105,106,107,108,109,110,
      111,112,113,114,115,116,117,118,119,120,
      121,122,123,124,125,126,127,128,129,130,
      131,132,133,134,135,136,137,138,139,140,
      141,142,143,144,145,146,147,148,149,150,
      151,152,153,154,155,156,157,158,159,160,
      161,162,163,164,165,166,167,168,169,170,
      171,172,173,174,175,176,177,178,179,180,
      181,182,183,184,185,186,187,188,189,190,
      191,192,193,194,195,196,197,198,199,200,
      201,202,203,204,205,206,207,208,209,210,
      211,212,213,214,215,216,217,218,219,220,
      221,222,223,224,225,226,227,228,229,230,
      231,232,233,234,235,236,237,238,239,240,
      241,242,243,244,245,246,247,248,249,250,
      251,252,253,254,255
    },
    /* latin 1 */
    {
        0,
        1,  2,  3,  4,  5,  6,  7,  8,  9, 10,
       11, 12, 13, 14, 15, 16, 17, 18, 19, 20,
       21, 22, 23, 24, 25, 26, 27, 28, 29, 30,
       31, 32, 33, 34, 35, 36, 37, 38, 39, 40,
       41, 42, 43, 44, 45, 46, 47, 48, 49, 50,
       51, 52, 53, 54, 55, 56, 57, 58, 59, 60,
       61, 62, 63, 64,
                       97, 98, 99,100,101,102, /* ABCDEF -> abcdef */
      103,104,105,106,107,108,109,110,111,112, /* GHIJKLMNOP -> ghijklmnop */
      113,114,115,116,117,118,119,120,121,122, /* QRSTUVWXYZ -> qrstuvwxyz */

       91, 92, 93, 94, 95, 96, 97, 98, 99,100, /* normal */
      101,102,103,104,105,106,107,108,109,110,
      111,112,113,114,115,116,117,118,119,120,
      121,122,123,124,125,126,127,128,129,130,
      131,132,133,134,135,136,137,138,139,140,
      141,142,143,144,145,146,147,148,149,150,
      151,152,153,154,155,156,157,158,159,160,
      161,162,163,164,165,166,167,168,169,170,
      171,172,173,174,175,176,177,178,179,180,
      181,182,183,184,185,186,187,188,189,190,
      191,
          224,225,226,227,228,229,230,231,232, /* 192-222 -> x+32 but not 215 */
      233,234,235,236,237,238,239,240,241,242,
      243,244,245,246,215,248,249,250,251,252,
      253,254,
              223,224,225,226,227,228,229,230,
      231,232,233,234,235,236,237,238,239,240,
      241,242,243,244,245,246,247,248,249,250,
      251,252,253,254,255
    },
    /* latin2 : TODO currently the same as ASCII */
    {
        0,
        1,  2,  3,  4,  5,  6,  7,  8,  9, 10,
       11, 12, 13, 14, 15, 16, 17, 18, 19, 20,
       21, 22, 23, 24, 25, 26, 27, 28, 29, 30,
       31, 32, 33, 34, 35, 36, 37, 38, 39, 40,
       41, 42, 43, 44, 45, 46, 47, 48, 49, 50,
       51, 52, 53, 54, 55, 56, 57, 58, 59, 60,
       61, 62, 63, 64,
                       97, 98, 99,100,101,102, /* ABCDEF -> abcdef */
      103,104,105,106,107,108,109,110,111,112, /* GHIJKLMNOP -> ghijklmnop */
      113,114,115,116,117,118,119,120,121,122, /* QRSTUVWXYZ -> qrstuvwxyz */

       91, 92, 93, 94, 95, 96, 97, 98, 99,100, /* normal */
      101,102,103,104,105,106,107,108,109,110,
      111,112,113,114,115,116,117,118,119,120,
      121,122,123,124,125,126,127,128,129,130,
      131,132,133,134,135,136,137,138,139,140,
      141,142,143,144,145,146,147,148,149,150,
      151,152,153,154,155,156,157,158,159,160,
      161,162,163,164,165,166,167,168,169,170,
      171,172,173,174,175,176,177,178,179,180,
      181,182,183,184,185,186,187,188,189,190,
      191,192,193,194,195,196,197,198,199,200,
      201,202,203,204,205,206,207,208,209,210,
      211,212,213,214,215,216,217,218,219,220,
      221,222,223,224,225,226,227,228,229,230,
      231,232,233,234,235,236,237,238,239,240,
      241,242,243,244,245,246,247,248,249,250,
      251,252,253,254,255
    },
    /* latin3 : TODO currently the same as ASCII */
    {
        0,
        1,  2,  3,  4,  5,  6,  7,  8,  9, 10,
       11, 12, 13, 14, 15, 16, 17, 18, 19, 20,
       21, 22, 23, 24, 25, 26, 27, 28, 29, 30,
       31, 32, 33, 34, 35, 36, 37, 38, 39, 40,
       41, 42, 43, 44, 45, 46, 47, 48, 49, 50,
       51, 52, 53, 54, 55, 56, 57, 58, 59, 60,
       61, 62, 63, 64,
                       97, 98, 99,100,101,102, /* ABCDEF -> abcdef */
      103,104,105,106,107,108,109,110,111,112, /* GHIJKLMNOP -> ghijklmnop */
      113,114,115,116,117,118,119,120,121,122, /* QRSTUVWXYZ -> qrstuvwxyz */

       91, 92, 93, 94, 95, 96, 97, 98, 99,100, /* normal */
      101,102,103,104,105,106,107,108,109,110,
      111,112,113,114,115,116,117,118,119,120,
      121,122,123,124,125,126,127,128,129,130,
      131,132,133,134,135,136,137,138,139,140,
      141,142,143,144,145,146,147,148,149,150,
      151,152,153,154,155,156,157,158,159,160,
      161,162,163,164,165,166,167,168,169,170,
      171,172,173,174,175,176,177,178,179,180,
      181,182,183,184,185,186,187,188,189,190,
      191,192,193,194,195,196,197,198,199,200,
      201,202,203,204,205,206,207,208,209,210,
      211,212,213,214,215,216,217,218,219,220,
      221,222,223,224,225,226,227,228,229,230,
      231,232,233,234,235,236,237,238,239,240,
      241,242,243,244,245,246,247,248,249,250,
      251,252,253,254,255
    },
    /* latin4 : TODO currently the same as ASCII */
    {
        0,
        1,  2,  3,  4,  5,  6,  7,  8,  9, 10,
       11, 12, 13, 14, 15, 16, 17, 18, 19, 20,
       21, 22, 23, 24, 25, 26, 27, 28, 29, 30,
       31, 32, 33, 34, 35, 36, 37, 38, 39, 40,
       41, 42, 43, 44, 45, 46, 47, 48, 49, 50,
       51, 52, 53, 54, 55, 56, 57, 58, 59, 60,
       61, 62, 63, 64,
                       97, 98, 99,100,101,102, /* ABCDEF -> abcdef */
      103,104,105,106,107,108,109,110,111,112, /* GHIJKLMNOP -> ghijklmnop */
      113,114,115,116,117,118,119,120,121,122, /* QRSTUVWXYZ -> qrstuvwxyz */

       91, 92, 93, 94, 95, 96, 97, 98, 99,100, /* normal */
      101,102,103,104,105,106,107,108,109,110,
      111,112,113,114,115,116,117,118,119,120,
      121,122,123,124,125,126,127,128,129,130,
      131,132,133,134,135,136,137,138,139,140,
      141,142,143,144,145,146,147,148,149,150,
      151,152,153,154,155,156,157,158,159,160,
      161,162,163,164,165,166,167,168,169,170,
      171,172,173,174,175,176,177,178,179,180,
      181,182,183,184,185,186,187,188,189,190,
      191,192,193,194,195,196,197,198,199,200,
      201,202,203,204,205,206,207,208,209,210,
      211,212,213,214,215,216,217,218,219,220,
      221,222,223,224,225,226,227,228,229,230,
      231,232,233,234,235,236,237,238,239,240,
      241,242,243,244,245,246,247,248,249,250,
      251,252,253,254,255
    },
    /* cyrillic : TODO currently the same as ASCII */
    {
        0,
        1,  2,  3,  4,  5,  6,  7,  8,  9, 10,
       11, 12, 13, 14, 15, 16, 17, 18, 19, 20,
       21, 22, 23, 24, 25, 26, 27, 28, 29, 30,
       31, 32, 33, 34, 35, 36, 37, 38, 39, 40,
       41, 42, 43, 44, 45, 46, 47, 48, 49, 50,
       51, 52, 53, 54, 55, 56, 57, 58, 59, 60,
       61, 62, 63, 64,
                       97, 98, 99,100,101,102, /* ABCDEF -> abcdef */
      103,104,105,106,107,108,109,110,111,112, /* GHIJKLMNOP -> ghijklmnop */
      113,114,115,116,117,118,119,120,121,122, /* QRSTUVWXYZ -> qrstuvwxyz */

       91, 92, 93, 94, 95, 96, 97, 98, 99,100, /* normal */
      101,102,103,104,105,106,107,108,109,110,
      111,112,113,114,115,116,117,118,119,120,
      121,122,123,124,125,126,127,128,129,130,
      131,132,133,134,135,136,137,138,139,140,
      141,142,143,144,145,146,147,148,149,150,
      151,152,153,154,155,156,157,158,159,160,
      161,162,163,164,165,166,167,168,169,170,
      171,172,173,174,175,176,177,178,179,180,
      181,182,183,184,185,186,187,188,189,190,
      191,192,193,194,195,196,197,198,199,200,
      201,202,203,204,205,206,207,208,209,210,
      211,212,213,214,215,216,217,218,219,220,
      221,222,223,224,225,226,227,228,229,230,
      231,232,233,234,235,236,237,238,239,240,
      241,242,243,244,245,246,247,248,249,250,
      251,252,253,254,255
    },
    /* arabic : TODO currently the same as ASCII */
    {
        0,
        1,  2,  3,  4,  5,  6,  7,  8,  9, 10,
       11, 12, 13, 14, 15, 16, 17, 18, 19, 20,
       21, 22, 23, 24, 25, 26, 27, 28, 29, 30,
       31, 32, 33, 34, 35, 36, 37, 38, 39, 40,
       41, 42, 43, 44, 45, 46, 47, 48, 49, 50,
       51, 52, 53, 54, 55, 56, 57, 58, 59, 60,
       61, 62, 63, 64,
                       97, 98, 99,100,101,102, /* ABCDEF -> abcdef */
      103,104,105,106,107,108,109,110,111,112, /* GHIJKLMNOP -> ghijklmnop */
      113,114,115,116,117,118,119,120,121,122, /* QRSTUVWXYZ -> qrstuvwxyz */

       91, 92, 93, 94, 95, 96, 97, 98, 99,100, /* normal */
      101,102,103,104,105,106,107,108,109,110,
      111,112,113,114,115,116,117,118,119,120,
      121,122,123,124,125,126,127,128,129,130,
      131,132,133,134,135,136,137,138,139,140,
      141,142,143,144,145,146,147,148,149,150,
      151,152,153,154,155,156,157,158,159,160,
      161,162,163,164,165,166,167,168,169,170,
      171,172,173,174,175,176,177,178,179,180,
      181,182,183,184,185,186,187,188,189,190,
      191,192,193,194,195,196,197,198,199,200,
      201,202,203,204,205,206,207,208,209,210,
      211,212,213,214,215,216,217,218,219,220,
      221,222,223,224,225,226,227,228,229,230,
      231,232,233,234,235,236,237,238,239,240,
      241,242,243,244,245,246,247,248,249,250,
      251,252,253,254,255
    },
    /* greek : TODO currently the same as ASCII */
    {
        0,
        1,  2,  3,  4,  5,  6,  7,  8,  9, 10,
       11, 12, 13, 14, 15, 16, 17, 18, 19, 20,
       21, 22, 23, 24, 25, 26, 27, 28, 29, 30,
       31, 32, 33, 34, 35, 36, 37, 38, 39, 40,
       41, 42, 43, 44, 45, 46, 47, 48, 49, 50,
       51, 52, 53, 54, 55, 56, 57, 58, 59, 60,
       61, 62, 63, 64,
                       97, 98, 99,100,101,102, /* ABCDEF -> abcdef */
      103,104,105,106,107,108,109,110,111,112, /* GHIJKLMNOP -> ghijklmnop */
      113,114,115,116,117,118,119,120,121,122, /* QRSTUVWXYZ -> qrstuvwxyz */

       91, 92, 93, 94, 95, 96, 97, 98, 99,100, /* normal */
      101,102,103,104,105,106,107,108,109,110,
      111,112,113,114,115,116,117,118,119,120,
      121,122,123,124,125,126,127,128,129,130,
      131,132,133,134,135,136,137,138,139,140,
      141,142,143,144,145,146,147,148,149,150,
      151,152,153,154,155,156,157,158,159,160,
      161,162,163,164,165,166,167,168,169,170,
      171,172,173,174,175,176,177,178,179,180,
      181,182,183,184,185,186,187,188,189,190,
      191,192,193,194,195,196,197,198,199,200,
      201,202,203,204,205,206,207,208,209,210,
      211,212,213,214,215,216,217,218,219,220,
      221,222,223,224,225,226,227,228,229,230,
      231,232,233,234,235,236,237,238,239,240,
      241,242,243,244,245,246,247,248,249,250,
      251,252,253,254,255
    },
    /* hebrew : TODO currently the same as ASCII */
    {
        0,
        1,  2,  3,  4,  5,  6,  7,  8,  9, 10,
       11, 12, 13, 14, 15, 16, 17, 18, 19, 20,
       21, 22, 23, 24, 25, 26, 27, 28, 29, 30,
       31, 32, 33, 34, 35, 36, 37, 38, 39, 40,
       41, 42, 43, 44, 45, 46, 47, 48, 49, 50,
       51, 52, 53, 54, 55, 56, 57, 58, 59, 60,
       61, 62, 63, 64,
                       97, 98, 99,100,101,102, /* ABCDEF -> abcdef */
      103,104,105,106,107,108,109,110,111,112, /* GHIJKLMNOP -> ghijklmnop */
      113,114,115,116,117,118,119,120,121,122, /* QRSTUVWXYZ -> qrstuvwxyz */

       91, 92, 93, 94, 95, 96, 97, 98, 99,100, /* normal */
      101,102,103,104,105,106,107,108,109,110,
      111,112,113,114,115,116,117,118,119,120,
      121,122,123,124,125,126,127,128,129,130,
      131,132,133,134,135,136,137,138,139,140,
      141,142,143,144,145,146,147,148,149,150,
      151,152,153,154,155,156,157,158,159,160,
      161,162,163,164,165,166,167,168,169,170,
      171,172,173,174,175,176,177,178,179,180,
      181,182,183,184,185,186,187,188,189,190,
      191,192,193,194,195,196,197,198,199,200,
      201,202,203,204,205,206,207,208,209,210,
      211,212,213,214,215,216,217,218,219,220,
      221,222,223,224,225,226,227,228,229,230,
      231,232,233,234,235,236,237,238,239,240,
      241,242,243,244,245,246,247,248,249,250,
      251,252,253,254,255
    },
    /* latin5 : TODO currently the same as ASCII */
    {
        0,
        1,  2,  3,  4,  5,  6,  7,  8,  9, 10,
       11, 12, 13, 14, 15, 16, 17, 18, 19, 20,
       21, 22, 23, 24, 25, 26, 27, 28, 29, 30,
       31, 32, 33, 34, 35, 36, 37, 38, 39, 40,
       41, 42, 43, 44, 45, 46, 47, 48, 49, 50,
       51, 52, 53, 54, 55, 56, 57, 58, 59, 60,
       61, 62, 63, 64,
                       97, 98, 99,100,101,102, /* ABCDEF -> abcdef */
      103,104,105,106,107,108,109,110,111,112, /* GHIJKLMNOP -> ghijklmnop */
      113,114,115,116,117,118,119,120,121,122, /* QRSTUVWXYZ -> qrstuvwxyz */

       91, 92, 93, 94, 95, 96, 97, 98, 99,100, /* normal */
      101,102,103,104,105,106,107,108,109,110,
      111,112,113,114,115,116,117,118,119,120,
      121,122,123,124,125,126,127,128,129,130,
      131,132,133,134,135,136,137,138,139,140,
      141,142,143,144,145,146,147,148,149,150,
      151,152,153,154,155,156,157,158,159,160,
      161,162,163,164,165,166,167,168,169,170,
      171,172,173,174,175,176,177,178,179,180,
      181,182,183,184,185,186,187,188,189,190,
      191,192,193,194,195,196,197,198,199,200,
      201,202,203,204,205,206,207,208,209,210,
      211,212,213,214,215,216,217,218,219,220,
      221,222,223,224,225,226,227,228,229,230,
      231,232,233,234,235,236,237,238,239,240,
      241,242,243,244,245,246,247,248,249,250,
      251,252,253,254,255
    },
    /* latin6 : TODO currently the same as ASCII */
    {
        0,
        1,  2,  3,  4,  5,  6,  7,  8,  9, 10,
       11, 12, 13, 14, 15, 16, 17, 18, 19, 20,
       21, 22, 23, 24, 25, 26, 27, 28, 29, 30,
       31, 32, 33, 34, 35, 36, 37, 38, 39, 40,
       41, 42, 43, 44, 45, 46, 47, 48, 49, 50,
       51, 52, 53, 54, 55, 56, 57, 58, 59, 60,
       61, 62, 63, 64,
                       97, 98, 99,100,101,102, /* ABCDEF -> abcdef */
      103,104,105,106,107,108,109,110,111,112, /* GHIJKLMNOP -> ghijklmnop */
      113,114,115,116,117,118,119,120,121,122, /* QRSTUVWXYZ -> qrstuvwxyz */

       91, 92, 93, 94, 95, 96, 97, 98, 99,100, /* normal */
      101,102,103,104,105,106,107,108,109,110,
      111,112,113,114,115,116,117,118,119,120,
      121,122,123,124,125,126,127,128,129,130,
      131,132,133,134,135,136,137,138,139,140,
      141,142,143,144,145,146,147,148,149,150,
      151,152,153,154,155,156,157,158,159,160,
      161,162,163,164,165,166,167,168,169,170,
      171,172,173,174,175,176,177,178,179,180,
      181,182,183,184,185,186,187,188,189,190,
      191,192,193,194,195,196,197,198,199,200,
      201,202,203,204,205,206,207,208,209,210,
      211,212,213,214,215,216,217,218,219,220,
      221,222,223,224,225,226,227,228,229,230,
      231,232,233,234,235,236,237,238,239,240,
      241,242,243,244,245,246,247,248,249,250,
      251,252,253,254,255
    },
    /* latin7 : TODO currently the same as ASCII */
    {
        0,
        1,  2,  3,  4,  5,  6,  7,  8,  9, 10,
       11, 12, 13, 14, 15, 16, 17, 18, 19, 20,
       21, 22, 23, 24, 25, 26, 27, 28, 29, 30,
       31, 32, 33, 34, 35, 36, 37, 38, 39, 40,
       41, 42, 43, 44, 45, 46, 47, 48, 49, 50,
       51, 52, 53, 54, 55, 56, 57, 58, 59, 60,
       61, 62, 63, 64,
                       97, 98, 99,100,101,102, /* ABCDEF -> abcdef */
      103,104,105,106,107,108,109,110,111,112, /* GHIJKLMNOP -> ghijklmnop */
      113,114,115,116,117,118,119,120,121,122, /* QRSTUVWXYZ -> qrstuvwxyz */

       91, 92, 93, 94, 95, 96, 97, 98, 99,100, /* normal */
      101,102,103,104,105,106,107,108,109,110,
      111,112,113,114,115,116,117,118,119,120,
      121,122,123,124,125,126,127,128,129,130,
      131,132,133,134,135,136,137,138,139,140,
      141,142,143,144,145,146,147,148,149,150,
      151,152,153,154,155,156,157,158,159,160,
      161,162,163,164,165,166,167,168,169,170,
      171,172,173,174,175,176,177,178,179,180,
      181,182,183,184,185,186,187,188,189,190,
      191,192,193,194,195,196,197,198,199,200,
      201,202,203,204,205,206,207,208,209,210,
      211,212,213,214,215,216,217,218,219,220,
      221,222,223,224,225,226,227,228,229,230,
      231,232,233,234,235,236,237,238,239,240,
      241,242,243,244,245,246,247,248,249,250,
      251,252,253,254,255
    },
    /* latin8 : TODO currently the same as ASCII */
    {
        0,
        1,  2,  3,  4,  5,  6,  7,  8,  9, 10,
       11, 12, 13, 14, 15, 16, 17, 18, 19, 20,
       21, 22, 23, 24, 25, 26, 27, 28, 29, 30,
       31, 32, 33, 34, 35, 36, 37, 38, 39, 40,
       41, 42, 43, 44, 45, 46, 47, 48, 49, 50,
       51, 52, 53, 54, 55, 56, 57, 58, 59, 60,
       61, 62, 63, 64,
                       97, 98, 99,100,101,102, /* ABCDEF -> abcdef */
      103,104,105,106,107,108,109,110,111,112, /* GHIJKLMNOP -> ghijklmnop */
      113,114,115,116,117,118,119,120,121,122, /* QRSTUVWXYZ -> qrstuvwxyz */

       91, 92, 93, 94, 95, 96, 97, 98, 99,100, /* normal */
      101,102,103,104,105,106,107,108,109,110,
      111,112,113,114,115,116,117,118,119,120,
      121,122,123,124,125,126,127,128,129,130,
      131,132,133,134,135,136,137,138,139,140,
      141,142,143,144,145,146,147,148,149,150,
      151,152,153,154,155,156,157,158,159,160,
      161,162,163,164,165,166,167,168,169,170,
      171,172,173,174,175,176,177,178,179,180,
      181,182,183,184,185,186,187,188,189,190,
      191,192,193,194,195,196,197,198,199,200,
      201,202,203,204,205,206,207,208,209,210,
      211,212,213,214,215,216,217,218,219,220,
      221,222,223,224,225,226,227,228,229,230,
      231,232,233,234,235,236,237,238,239,240,
      241,242,243,244,245,246,247,248,249,250,
      251,252,253,254,255
    },
    /* latin9 : TODO currently the same as ASCII */
    {
        0,
        1,  2,  3,  4,  5,  6,  7,  8,  9, 10,
       11, 12, 13, 14, 15, 16, 17, 18, 19, 20,
       21, 22, 23, 24, 25, 26, 27, 28, 29, 30,
       31, 32, 33, 34, 35, 36, 37, 38, 39, 40,
       41, 42, 43, 44, 45, 46, 47, 48, 49, 50,
       51, 52, 53, 54, 55, 56, 57, 58, 59, 60,
       61, 62, 63, 64,
                       97, 98, 99,100,101,102, /* ABCDEF -> abcdef */
      103,104,105,106,107,108,109,110,111,112, /* GHIJKLMNOP -> ghijklmnop */
      113,114,115,116,117,118,119,120,121,122, /* QRSTUVWXYZ -> qrstuvwxyz */

       91, 92, 93, 94, 95, 96, 97, 98, 99,100, /* normal */
      101,102,103,104,105,106,107,108,109,110,
      111,112,113,114,115,116,117,118,119,120,
      121,122,123,124,125,126,127,128,129,130,
      131,132,133,134,135,136,137,138,139,140,
      141,142,143,144,145,146,147,148,149,150,
      151,152,153,154,155,156,157,158,159,160,
      161,162,163,164,165,166,167,168,169,170,
      171,172,173,174,175,176,177,178,179,180,
      181,182,183,184,185,186,187,188,189,190,
      191,192,193,194,195,196,197,198,199,200,
      201,202,203,204,205,206,207,208,209,210,
      211,212,213,214,215,216,217,218,219,220,
      221,222,223,224,225,226,227,228,229,230,
      231,232,233,234,235,236,237,238,239,240,
      241,242,243,244,245,246,247,248,249,250,
      251,252,253,254,255
    },
    /* UTF8: a dummy table which should never be used. The big wall
     * of zeroes should function as a reminder of this! */
    {
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    }
};  /* end initialise: nocase tables */


/* endof massive character data built-ins! */

/* following are old versions, should not be needed any longer */

/**
 * Table which translates latin-1 characters to lowercase.
 *
 * Use cl_string_maptable to access.
 * @see cl_string_maptable
 */
unsigned char latin1_nocase_tab[256] = {
    0,  
    1,  2,  3,  4,  5,  6,  7,  8,  9, 10,
   11, 12, 13, 14, 15, 16, 17, 18, 19, 20,
   21, 22, 23, 24, 25, 26, 27, 28, 29, 30,
   31, 32, 33, 34, 35, 36, 37, 38, 39, 40,
   41, 42, 43, 44, 45, 46, 47, 48, 49, 50,
   51, 52, 53, 54, 55, 56, 57, 58, 59, 60,
   61, 62, 63, 64,
                   97, 98, 99,100,101,102, /* ABCDEF -> abcdef */
  103,104,105,106,107,108,109,110,111,112, /* GHIJKLMNOP -> ghijklmnop */
  113,114,115,116,117,118,119,120,121,122, /* QRSTUVWXYZ -> qrstuvwxyz */
  
   91, 92, 93, 94, 95, 96, 97, 98, 99,100, /* normal */
  101,102,103,104,105,106,107,108,109,110,
  111,112,113,114,115,116,117,118,119,120,
  121,122,123,124,125,126,127,128,129,130,
  131,132,133,134,135,136,137,138,139,140,
  141,142,143,144,145,146,147,148,149,150,
  151,152,153,154,155,156,157,158,159,160,
  161,162,163,164,165,166,167,168,169,170,
  171,172,173,174,175,176,177,178,179,180,
  181,182,183,184,185,186,187,188,189,190,
  191,
      224,225,226,227,228,229,230,231,232, /* 192-222 -> x+32 but not 215 */
  233,234,235,236,237,238,239,240,241,242,
  243,244,245,246,215,248,249,250,251,252,
  253,254,
          223,224,225,226,227,228,229,230,
  231,232,233,234,235,236,237,238,239,240,
  241,242,243,244,245,246,247,248,249,250,
  251,252,253,254,255
};

/**
 * Table which translates latin-1 characters
 * with diacritics to their [A-Za-z] "equivalents",
 * including ß->s, þ->t
 *
 * Use cl_string_maptable to access.
 * @see cl_string_maptable
 */
unsigned char latin1_nodiac_tab[256] = {
    0,  
    1,  2,  3,  4,  5,  6,  7,  8,  9, 10,
   11, 12, 13, 14, 15, 16, 17, 18, 19, 20,
   21, 22, 23, 24, 25, 26, 27, 28, 29, 30,
   31, 32, 33, 34, 35, 36, 37, 38, 39, 40,
   41, 42, 43, 44, 45, 46, 47, 48, 49, 50,
   51, 52, 53, 54, 55, 56, 57, 58, 59, 60,
   61, 62, 63, 64, 65, 66, 67, 68, 69, 70,
   71, 72, 73, 74, 75, 76, 77, 78, 79, 80,
   81, 82, 83, 84, 85, 86, 87, 88, 89, 90,
   91, 92, 93, 94, 95, 96, 97, 98, 99,100,
  101,102,103,104,105,106,107,108,109,110,
  111,112,113,114,115,116,117,118,119,120,
  121,122,123,124,125,126,127,128,129,130,
  131,132,133,134,135,136,137,138,139,140,
  141,142,143,144,145,146,147,148,149,150,
  151,152,153,154,155,156,157,158,159,160,
  161,162,163,164,165,166,167,168,169,170,
  171,172,173,174,175,176,177,178,179,180,
  181,182,183,184,185,186,187,188,189,190,
  191,
       65, 65, 65, 65, 65, 65, 65, 67, 69, /* uppercase */
   69, 69, 69, 73, 73, 73, 73, 68, 78, 79,
   79, 79, 79, 79,215, 79, 85, 85, 85, 85,
   89, 84,115,                  /* thorn -> 'T', szlig -> 's' */
               97, 97, 97, 97, 97, 97, 97, /* lowercase */
   99,101,101,101,101,105,105,105,105,100,
  110,111,111,111,111,111,247,111,117,117,
  117,117,121,116,121
};

/**
 * Table which translates cp-1251 (ASCII +
 * cyrillic) characters to lowercase
 *
 * Use cl_string_maptable to access.
 * @see cl_string_maptable
 */
unsigned char cp1251_nocase_tab[256] = {
    0,  
    1,  2,  3,  4,  5,  6,  7,  8,  9, 10,
   11, 12, 13, 14, 15, 16, 17, 18, 19, 20,
   21, 22, 23, 24, 25, 26, 27, 28, 29, 30,
   31, 32, 33, 34, 35, 36, 37, 38, 39, 40,
   41, 42, 43, 44, 45, 46, 47, 48, 49, 50,
   51, 52, 53, 54, 55, 56, 57, 58, 59, 60,
   61, 62, 63, 64,
                   97, 98, 99,100,101,102, /* ABCDEF -> abcdef */
  103,104,105,106,107,108,109,110,111,112, /* GHIJKLMNOP -> ghijklmnop */
  113,114,115,116,117,118,119,120,121,122, /* QRSTUVWXYZ -> qrstuvwxyz */
  
   91, 92, 93, 94, 95, 96, 97, 98, 99,100, /* normal */
  101,102,103,104,105,106,107,108,109,110,
  111,112,113,114,115,116,117,118,119,120,
  121,122,123,124,125,126,127,144,131,130,
  131,132,133,134,135,136,137,154,139,140,
  157,158,159,144,145,146,147,148,149,150,
  151,152,153,154,155,156,157,158,159,160,
  162,162,188,164,180,166,167,184,169,186,
  171,172,173,174,191,176,177,179,179,180,
  181,182,183,184,185,186,187,188,190,190,
  191,224,225,226,227,228,229,230,231,232,
  233,234,235,236,237,238,239,240,241,242,
  243,244,245,246,247,248,249,250,251,252,
  253,254,255,224,225,226,227,228,229,230,
  231,232,233,234,235,236,237,238,239,240,
  241,242,243,244,245,246,247,248,249,250,
  251,252,253,254,255
};

/* cp-1251 (ASCII + cyrillic) diacritic-stripping is just the identity mapping */


/*
***
unsigned char ascii_nocase_tab[256] = {
    0,  
    1,  2,  3,  4,  5,  6,  7,  8,  9, 10,
   11, 12, 13, 14, 15, 16, 17, 18, 19, 20,
   21, 22, 23, 24, 25, 26, 27, 28, 29, 30,
   31, 32, 33, 34, 35, 36, 37, 38, 39, 40,
   41, 42, 43, 44, 45, 46, 47, 48, 49, 50,
   51, 52, 53, 54, 55, 56, 57, 58, 59, 60,
   61, 62, 63, 64,
                   97, 98, 99,100,101,102, 
  103,104,105,106,107,108,109,110,111,112, 
  113,114,115,116,117,118,119,120,121,122, 
  
   91, 92, 93, 94, 95, 96, 97, 98, 99,100, 
  101,102,103,104,105,106,107,108,109,110,
  111,112,113,114,115,116,117,118,119,120,
  121,122,123,124,125,126,127,144,131,130,
  131,132,133,134,135,136,137,154,139,140,
  157,158,159,144,145,146,147,148,149,150,
  151,152,153,154,155,156,157,158,159,160,
  162,162,188,164,180,166,167,184,169,186,
  171,172,173,174,191,176,177,179,179,180,
  181,182,183,184,185,186,187,188,190,190,
  191,192,193,194,195,196,197,198,199,200,
  201,202,203,204,205,206,207,208,209,210,
  211,212,213,214,215,216,217,218,219,220,
  221,222,223,224,225,226,227,228,229,230,
  231,232,233,234,235,236,237,238,239,240,
  241,242,243,244,245,246,247,248,249,250,
  251,252,253,254,255
};
****/

/*
***
unsigned char binary_nocase_tab[256] = {
    0,  
    1,  2,  3,  4,  5,  6,  7,  8,  9, 10,
   11, 12, 13, 14, 15, 16, 17, 18, 19, 20,
   21, 22, 23, 24, 25, 26, 27, 28, 29, 30,
   31, 32, 33, 34, 35, 36, 37, 38, 39, 40,
   41, 42, 43, 44, 45, 46, 47, 48, 49, 50,
   51, 52, 53, 54, 55, 56, 57, 58, 59, 60,
   61, 62, 63, 64, 65, 66, 67, 68, 69, 70,
   71, 72, 73, 74, 75, 76, 77, 78, 79, 80,
   81, 82, 83, 84, 85, 86, 87, 88, 89, 90,
   91, 92, 93, 94, 95, 96, 97, 98, 99,100,
  101,102,103,104,105,106,107,108,109,110,
  111,112,113,114,115,116,117,118,119,120,
  121,122,123,124,125,126,127,144,131,130,
  131,132,133,134,135,136,137,154,139,140,
  157,158,159,144,145,146,147,148,149,150,
  151,152,153,154,155,156,157,158,159,160,
  162,162,188,164,180,166,167,184,169,186,
  171,172,173,174,191,176,177,179,179,180,
  181,182,183,184,185,186,187,188,190,190,
  191,192,193,194,195,196,197,198,199,200,
  201,202,203,204,205,206,207,208,209,210,
  211,212,213,214,215,216,217,218,219,220,
  221,222,223,224,225,226,227,228,229,230,
  231,232,233,234,235,236,237,238,239,240,
  241,242,243,244,245,246,247,248,249,250,
  251,252,253,254,255
};
****/

/**
 * Table with identity mapping of latin-1 characters
 * (no flags)
 *
 * Use cl_string_maptable to access.
 * @see cl_string_maptable
 */
unsigned char latin1_identity_tab[256];
int latin1_identity_tab_init = 0;

/**
 * Table with mapping for the %cd flag for latin-1
 * (no case, no diacritics).
 *
 * Use cl_string_maptable to access.
 * @see cl_string_maptable
 */
unsigned char latin1_nocase_nodiac_tab[256];
int latin1_nocase_nodiac_tab_init = 0;



/**
 * Initialise an "identity" mapping table.
 */
void
maptable_init_identity(unsigned char *maptable)
{
  int i;
  for (i = 0; i < 256; i++)
    maptable[i] = i;
}

/**
 * Initialise a "fold both case and diacritics" mapping table
 */
void
maptable_init_both(unsigned char *maptable,
                   const unsigned char *nocasetable,
                   const unsigned char *nodiactable)
{
  int i;
  for (i = 0; i < 256; i++) {
    maptable[i] = nocasetable[nodiactable[i]];
    if (maptable[i] != nodiactable[nocasetable[i]]) {
      fprintf(stderr, "CL: tables inconsistent for #%d -> #%d\n", i, maptable[i]);
    }
  }
}

/**
 * Gets a specified character mapping table for use in regular expressions.
 *
 * Returns pointer to static mapping table for given flags (IGNORE_CASE and
 * IGNORE_DIAC) and character set.
 *
 * Removed from the public API for 3.2.0 because there's no way for it to work
 * if the CorpusCharset is UTF8. Prototype moved to special-chars.h
 *
 * Tables exist for all character sets, but for all except Latin1 and ASCII, they are
 * currently identical to the ASCII tables (i.e. the awareness of case/accent
 * relationships in the upper half of each character set have not yet been inserted).
 *
 * @param charset  The character set of this corpus. Currently ignored.
 * @param flags    The flags that specify which table is required.
 *                 Can be IGNORE_CASE and/or IGNORE_DIAC.
 * @return         Pointer to the appropriate mapping table. DO NOT FREE this,
 *                 or modify it, it is a CL-internal data blob.
 */
unsigned char *
cl_string_maptable(CorpusCharset charset, int flags)
{
  int icase = (flags & IGNORE_CASE) != 0;
  int idiac = (flags & IGNORE_DIAC) != 0;

  if (charset == utf8) {
    fprintf(stderr, "CL: major error, cl_string_maptable called with invalid charset (UTF8).\n"
                    "    Mapping tables for ASCII have been supplied, but this means any \n"
                    "    characters outside the ASCII range will NOT be correct!\n");
    charset = ascii;
  }

  if (icase && idiac) {
    if (! nocase_nodiac_tab_init[charset]) {
      maptable_init_both(nocase_nodiac_tab[charset], nocase_tab[charset], nodiac_tab[charset]);
      nocase_nodiac_tab_init[charset] = 1;
    }
    return nocase_nodiac_tab[charset];
  }
  else if (icase) {
    return nocase_tab[charset];
  }
  else if (idiac) {
    return nodiac_tab[charset];
  }
  else {
    if (! identity_tab_init[charset]) {
      maptable_init_identity(identity_tab[charset]);
      identity_tab_init[charset] = 1;
    }
    return identity_tab[charset];
  }
  /*
   * old version of code follows...
   *
  if (icase && idiac) {
    if (! latin1_nocase_nodiac_tab_init) {
      maptable_init_both(latin1_nocase_nodiac_tab, latin1_nocase_tab, latin1_nodiac_tab);
      latin1_nocase_nodiac_tab_init = 1;
    }
    return latin1_nocase_nodiac_tab;
  } 
  else if (icase) {
    return latin1_nocase_tab;
  }
  else if (idiac) {
    return latin1_nodiac_tab;
  }
  else {
    if (! latin1_identity_tab_init) {
      maptable_init_identity(latin1_identity_tab);
      latin1_identity_tab_init = 1;
    }
    return latin1_identity_tab;
  }
  // end old version */
}




/**
 * Converts a string to canonical form.
 *
 * The "canonical form" of a string is for use in comparisons where
 * case-insensitivity and/or diacritic insensitivity is desired.
 *
 * Note that the string s is modified in place. This means it must have enough
 * memory to cope with any expansions made in Unicode case folding. Ideally,
 * allocate double the length of the string (since case-folding doesn't include
 * any one -> more-than-two mappings so far as I know).
 *
 * Note also that the arguments of this string were changed in v3.2.1. Now,
 * a CorpusCharset is needed. This is because string canonicalising works
 * differently in UTF8. In UTF8, the "composed" status of ALL strings is
 * standardised (this is not dependent on flags; so this function should
 * always be called on all strings that are going to be inserted into or
 * searched for within, an indexed corpus; then we know we are always
 * dealing with maximally-precomposed strings). Then case folding / accent
 * folding is done by calling Unicode-aware functions. This is in contrast
 * to the process for Latin1, which just uses a straightforward mapping
 * table for both sorts of folding.
 *
 * @param s        The string (currently: must be Ascii, Latin-1, or UTF8!)
 * @param charset  The character set to use in standardising. If this is utf8,
 *                 complex accent and/or case folding will be done, as per the
 *                 unicode standard. If it is anything else, the Latin1 mapping
 *                 tables will be used (currently no other ISO mapping tables
 *                 are built in to the CL).
 * @param flags    The flags that specify which conversions are required.
 *                 Can be IGNORE_CASE and/or IGNORE_DIAC.
 */
void 
cl_string_canonical(char *s, CorpusCharset charset, int flags)
{

  /* this function has two branches controlle dby an if: (a) utf8, (b) everything else. */
  if (charset == utf8) {

    /* pointers for UTF8 processing */
    gchar *string = NULL;
    gchar *precomposed = NULL;
    gchar *folded = NULL;
    gchar *current_char;
    gchar *next_char_begins;

    int icase = (flags & IGNORE_CASE) != 0;
    int idiac = (flags & IGNORE_DIAC) != 0;

    /* UTF8 accent folding */
    if (idiac) {
      if (NULL == (string = g_utf8_normalize((gchar *)s, -1, G_NORMALIZE_NFD)) ) {
        fprintf(stderr, "CL: major error, invalid UTF8 string passed to cl_string_canonical...\n");
        return;
      }

      for (current_char = string; *current_char != '\0'; /* increment is done in-loop */) {
        next_char_begins = g_utf8_next_char(current_char);
        if (g_unichar_ismark(g_utf8_get_char(current_char))) {
          /* downcopy to overwrite the mark character */
          strcpy(current_char, next_char_begins);
          /* and keep current_char the same */
        }
        else
          current_char = next_char_begins;
      }
    }
    /* end of accent folding */
    else
      string = (gchar *)s;

    /* UTF8 precomposing -- always happens */
    precomposed = g_utf8_normalize(string, -1, G_NORMALIZE_NFC);
    if (NULL == (precomposed = g_utf8_normalize(string, -1, G_NORMALIZE_NFC)) ) {
      fprintf(stderr, "CL: major error, invalid UTF8 string passed to cl_string_canonical...\n");
      return;
    }

    if (string != s)
      cl_free(string);

    /* UTF8 case folding */
    if (icase) {
      folded = g_utf8_casefold(precomposed, -1);
      cl_free(precomposed);
    }
    else
      folded = precomposed;

    /* Note: if you haven't allocated enough memory at s, this will cause a buffer overflow. */
    strcpy(s, folded);
    cl_free(folded);

  }
  /* end chunk dealing with UTF8 normalisation */

  else {
    /* variables for non-UTF8 normalisation */
    register unsigned char *p, *maptable;

    /* ASCII or Latin-1; note that when maptables for other Latin-X charsets are added,
     * no changes will be needed here - it will just work as long as cl_string_maptable
     * is aware of the right character sets. */
    if (flags) {                  /* don't waste time if no flags are specified */
      maptable = cl_string_maptable(charset, flags);
      for (p = (unsigned char *)s; *p; p++) {
        *p = maptable[*p];
      }
    }
  }
}


/**
 * Standardises subdirectory-dividers in a string that represents a path, in an
 * OS-sensitive way.
 *
 * If the CL was compiled for Unix, backslash is changed to forwardslash.
 * If the CL was compiled for windows, forwardslash is changed to backslash.
 *
 * Note that the path is modified in place.
 *
 * @param path     The path to modify (must be Ascii-compatible)
 */
void
cl_path_adjust_os(char *path)
{
  for ( ; *path != '\0' ; path++ )
    if (*path == '/' || *path == '\\')
      *path = SUBDIR_SEPARATOR;
}

/**
 * Standardises subdirectory-dividers in a string that represents a path
 * into Unix-like form (ie with forward-slash), regardless of what OS
 * we are in.
 *
 * Or, to put it another way, changes backslashes into forward slashes
 * under Windows.
 *
 * This may be useful because of the need to move corpora between systems
 * - in which case, the paths need to be in '/' format -- Windows tolerates
 * forward slashes in paths a hell of a lot better than *nix tolerates
 * unescaped backslashes!
 *
 * Note that the path is modified in place.
 *
 * @param path     The path to modify (must be Ascii-compatible)
 */
void
cl_path_adjust_independent(char *path)
{
  for ( ; *path != '\0' ; path++ )
    if (*path == SUBDIR_SEPARATOR)
      *path = '/';
}


/**
 * Boolean switch enabling/disabling latex-style escapes.
 *
 * By default, it is false; if programs wish to allow these
 * escapes they need to offer some means of changing this
 * variable.
 *
 * Note that enabling this variable may cause scrambling of
 * the string for LatinX strings where X is not 1; and may cause
 * undefined errors for UTF8 strings. In short, you should
 * only activate it when you are working with a corpus whose
 * charset is Latin1.
 *
 * @see  CorpusCharset
 */
int cl_allow_latex2iso = 0;


/**
 * Converts ASCII strings with latex-style blackslash escapes
 * for accented characters to ISO-8859-1 (Latin-1).
 *
 * Syntax:
 *
 * \"[AaOoUus..] --> corresponding ISO 8859-1 character
 *
 * \{octal}      --> ISO 8859-1 character
 *
 * Note that if cl_allow_latex2iso is FALSE, this function will
 * simply copy the input to the output. So it is always safe to
 * call this function.
 *
 * @see               cl_allow_latex2iso
 * @param str         The string to convert.
 * @param result      The location to put the altered string (which
 *                    should be shorter, or at least no longer than,
 *                    the input string). If this parameter is NULL,
 *                    space is automatically allocated for the output.
 *                    result is allowed to be the same as str.
 * @param target_len  The maximum length of the target string. If
 *                    result is NULL, then this is deduced automatically.
 * @return            Pointer to the altered string (if result was NULL
 *                    you need to catch this and free it when no longer
 *                    needed).
 */
char *
cl_string_latex2iso(char *str, char *result, int target_len)
{
  /* the positions in the source and target strings */
  int src_pos = 0;
  int target_pos = 0;
  int i;

  char c;
  int val;

  /* do not allow latex-style escapes unless they are switched on in the global variable */
  if (! cl_allow_latex2iso) {
    if (result) {
      if (result != str)
        strcpy(result, str);
    }
    else
      result = cl_strdup(str);
    return result;
  }

/** @see cl_string_latex2iso */
#define popc(s,p) s[p++]
/** @see cl_string_latex2iso */
#define pushc(s,c,p,m) s[p++] = c; if (p>=m) goto endloop;

  if (result == NULL) {
    /* auto-allocate <result> if necessary; should be shorter than input string */
    target_len = strlen(str);
    result = (char *) cl_malloc(target_len + 1);
  }
  
  c = popc(str, src_pos);
  while ((c != '\0') && (target_pos < target_len)) {

    if (c != '\\') {
      pushc(result, c, target_pos, target_len);
      c = popc(str, src_pos);
    }
    else { /* we found a backslash */

      /* get the next character */
      c = popc(str, src_pos);

      if (isdigit(c) && isdigit(str[src_pos]) && isdigit(str[src_pos+1])) {
        val = 0;
        for (i = 0; i < 3; i++) {
          val = val * 8 + ((c - '0') % 8);
          c = popc(str, src_pos);
        }
        pushc(result, (char) (val % 256), target_pos, target_len);
      }
      else if (c == '"') {     /* diaresis / umlaut */
        switch ( c = popc(str, src_pos) ) {
        case 'A': pushc(result, 'Ä', target_pos, target_len); break;
        case 'E': pushc(result, 'Ë', target_pos, target_len); break;
        case 'I': pushc(result, 'Ï', target_pos, target_len); break;
        case 'O': pushc(result, 'Ö', target_pos, target_len); break;
        case 'U': pushc(result, 'Ü', target_pos, target_len); break;
        case 'a': pushc(result, 'ä', target_pos, target_len); break;
        case 'e': pushc(result, 'ë', target_pos, target_len); break;
        case 'i': pushc(result, 'ï', target_pos, target_len); break;
        case 'o': pushc(result, 'ö', target_pos, target_len); break;
        case 'u': pushc(result, 'ü', target_pos, target_len); break;
        case 's': pushc(result, 'ß', target_pos, target_len); break;
        default:   /* copy both */
          pushc(result, '"', target_pos, target_len);
          pushc(result, c,   target_pos, target_len);
          break;
        }
        c = popc(str, src_pos);
      }
      else if (c == '\'') {     /* accent aigu */
        switch ( c = popc(str, src_pos) ) {
        case 'A': pushc(result, 'Á', target_pos, target_len); break;
        case 'E': pushc(result, 'É', target_pos, target_len); break;
        case 'I': pushc(result, 'Í', target_pos, target_len); break;
        case 'O': pushc(result, 'Ó', target_pos, target_len); break;
        case 'U': pushc(result, 'Ú', target_pos, target_len); break;
        case 'a': pushc(result, 'á', target_pos, target_len); break;
        case 'e': pushc(result, 'é', target_pos, target_len); break;
        case 'i': pushc(result, 'í', target_pos, target_len); break;
        case 'o': pushc(result, 'ó', target_pos, target_len); break;
        case 'u': pushc(result, 'ú', target_pos, target_len); break;
        default:   /* copy both */
          pushc(result, '\'', target_pos, target_len);
          pushc(result, c,   target_pos, target_len);
          break;
        }
        c = popc(str, src_pos);
      }
      else if (c == '`') {      /* accent grave */
        switch ( c = popc(str, src_pos) ) {
        case 'A': pushc(result, 'À', target_pos, target_len); break;
        case 'E': pushc(result, 'È', target_pos, target_len); break;
        case 'I': pushc(result, 'Ì', target_pos, target_len); break;
        case 'O': pushc(result, 'Ò', target_pos, target_len); break;
        case 'U': pushc(result, 'Ù', target_pos, target_len); break;
        case 'a': pushc(result, 'à', target_pos, target_len); break;
        case 'e': pushc(result, 'è', target_pos, target_len); break;
        case 'i': pushc(result, 'ì', target_pos, target_len); break;
        case 'o': pushc(result, 'ò', target_pos, target_len); break;
        case 'u': pushc(result, 'ù', target_pos, target_len); break;
        default:   /* copy both */
          pushc(result, '`', target_pos, target_len);
          pushc(result, c,   target_pos, target_len);
          break;
        }
        c = popc(str, src_pos);
      }
      else if (c == '^') {      /* accent circonflex */
        switch ( c = popc(str, src_pos) ) {
        case 'A': pushc(result, 'Â', target_pos, target_len); break;
        case 'E': pushc(result, 'Ê', target_pos, target_len); break;
        case 'I': pushc(result, 'Î', target_pos, target_len); break;
        case 'O': pushc(result, 'Ô', target_pos, target_len); break;
        case 'U': pushc(result, 'í', target_pos, target_len); break;
        case 'a': pushc(result, 'â', target_pos, target_len); break;
        case 'e': pushc(result, 'ê', target_pos, target_len); break;
        case 'i': pushc(result, 'î', target_pos, target_len); break;
        case 'o': pushc(result, 'ô', target_pos, target_len); break;
        case 'u': pushc(result, 'û', target_pos, target_len); break;
        default:   /* copy both */
          pushc(result, '^', target_pos, target_len);
          pushc(result, c,   target_pos, target_len);
          break;
        }
        c = popc(str, src_pos);
      }
      else if (c == ',') {      /* cedille */
        switch ( c = popc(str, src_pos) ) {
        case 'C': pushc(result, 'Ç', target_pos, target_len); break;
        case 'c': pushc(result, 'ç', target_pos, target_len); break;
        default:   /* copy both */
          pushc(result, ',', target_pos, target_len);
          pushc(result, c,   target_pos, target_len);
          break;
        }
        c = popc(str, src_pos);
      }
      else if (c == '~') {
        switch ( c = popc(str, src_pos) ) {
        case 'n': pushc(result, 'ñ', target_pos, target_len); break;
        case 'N': pushc(result, 'Ñ', target_pos, target_len); break;
        default:   /* copy both */
          pushc(result, '~', target_pos, target_len);
          pushc(result, c,   target_pos, target_len);
          break;
        }
        c = popc(str, src_pos);
      }
      else /* copy both */ {
        pushc(result, '\\', target_pos, target_len);
        pushc(result, c, target_pos, target_len);
        c = popc(str, src_pos);
      }
    }
  }
  
endloop:
  result[target_pos] = '\0';

  return result;
}



